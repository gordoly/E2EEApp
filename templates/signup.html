{% extends 'base.html' %}

{% load static %}

{% block content %}
    <div class="login-signup"> 
        <h1>Sign Up</h1>
        <p>Username</p>
        <input id="username"/>
        <p>Password</p>
        <input id="password" type="password"/>
        <p>First name</p>
        <input id="first_name"/>
        <p>Last name</p>
        <input id="last_name"/>
        <p>Something about you</p>
        <textarea id="about" rows="4" cols="50" style="resize: none;"></textarea>
        <br>
        <br>
        <button onclick="signup()">Sign up</button>
    </div>

    <script src="{% static 'js/libs/crypto.js' %}"></script>
    <script>
        async function signup() {
            let res = await axios.post('/auth/register/', {
                username: $("#username").val(),
                password: $("#password").val(),
                first_name: $("#first_name").val(),
                last_name: $("#last_name").val(),
                about: $("#about").val()
            }, {
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (res.status === 200) {
                const db = await openDatabase();

                const salt = generateRandomBytes();
                const iv = generateRandomBytes();

                // imports the user's password for use by KDF
                const keyMaterial = await crypto.subtle.importKey(
                    "raw", 
                    new TextEncoder().encode($("#password").val()),
                    { name: 'PBKDF2' },
                    false,
                    ["deriveBits", "deriveKey"]
                );
                
                // derive a key from the user's password
                const pwdDerivedKey =  await crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: 100000,
                        hash: "SHA-256",
                    },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    true,
                    ["encrypt", "decrypt"],
                );

                const keyPair = await generateKeyPair();
                const encryptedPrivate = await encryptRSAKey(keyPair.privateKey, pwdDerivedKey, iv);

                await setData(db, "keys", {"id": 1, "type": "salt", "content": salt});
                await addData(db, "keys", {"id": 2, "type": "iv", "content": iv});
                await addData(db, "keys", {"id": 3, "type": "private", "content": encryptedPrivate});

                const exported = await crypto.subtle.exportKey(
                    'spki',
                    keyPair.publicKey
                );
                
                await axios.post("/key/save/", {
                    "public_key": Array.from(new Uint8Array(exported))
                });

                document.location.href = res.data["message"];
            }
            else {
                alert(res.data["message"]);
            }
        }
    </script>
{% endblock %}