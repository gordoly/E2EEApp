{% extends 'base.html' %}

{% load static %}

{% block content %}
    <div class="login-signup">
        <h1>Login</h1>
        <p>Username</p>
        <input id="username"/>
        <p>Password</p>
        <input id="password"  type="password"/>
        <br>
        <br>
        <button onclick="login()">Login</button>
    </div>

    <script src="{% static 'js/libs/crypto.js' %}"></script>
    <script>
        document.addEventListener('keydown', function(event) {
            if (event.keyCode === 13) {
                login();
            }
        });

        async function login() {
            // axios post the username and password to the server
            const res = await axios.post("/auth/login/", {
                username: $("#username").val(),
                password: $("#password").val()
            });

            // if the server sends in an error message, alert() the error message
            if (res.status === 200) {
                const db = await openDatabase();
                const keyData = await getData(db, "keys");

                let salt;
                let iv;
                let privateKey;

                // use the key data if saved in IndexedDB, otherwise generate new ones
                if (keyData.length === 0) {
                    salt = generateRandomBytes();
                    iv = generateRandomBytes();
                }
                else {
                    for (let data of keyData) {
                        if (data["type"] === "salt") {
                            salt = data["content"];
                        } else if (data["type"] === "iv") {
                            iv = data["content"];
                        } else if (data["type"] === "private") {
                            privateKey = data["content"];
                        }
                    }
                }

                // imports the user's password for use by KDF
                const keyMaterial = await crypto.subtle.importKey(
                    "raw", 
                    new TextEncoder().encode($("#password").val()),
                    { name: 'PBKDF2' },
                    false, 
                    ["deriveBits", "deriveKey"]
                );
                
                // derive a key from the user's password
                const pwdDerivedKey =  await crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: 100000,
                        hash: "SHA-256",
                    },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    true,
                    ["encrypt", "decrypt"],
                );

                const indexDBMessages = await getData(db, "messages");
                let msgHistory = [];

                if (indexDBMessages.length > 0) {
                    msgHistory = await decryptMsgHistory(indexDBMessages[0]["content"], pwdDerivedKey, iv);
                }
                
                const messages_res = await axios.get("/history");
                const messages = messages_res.data["messages"];

                if (Object.keys(messages).length > 0) {            
                    privateKey = await decryptRSAKey(privateKey, pwdDerivedKey, iv);

                    for (let message of messages) {
                        try {
                            const msg = await decryptMessage(privateKey, new Uint8Array(JSON.parse(message["content"])));
                            message["content"] = msg;
                            msgHistory.push(message);
                        }
                        catch {
                            
                        }
                    }

                    const encryptedMsgHistory = await encryptMsgHistory(msgHistory, pwdDerivedKey, iv);
                    await setData(db, "messages", {"id": 1, "content": encryptedMsgHistory});
                }

                const keyPair = await generateKeyPair();
                const encryptedPrivate = await encryptRSAKey(keyPair.privateKey, pwdDerivedKey, iv);
                
                await setData(db, "keys", {"id": 1, "type": "salt", "content": salt});
                await addData(db, "keys", {"id": 2, "type": "iv", "content": iv});
                await addData(db, "keys", {"id": 3, "type": "private", "content": encryptedPrivate});

                const exported = await crypto.subtle.exportKey(
                    'spki',
                    keyPair.publicKey
                );
                
                await axios.post("/key/save/", {
                    "public_key": Array.from(new Uint8Array(exported))
                });
                
                document.location.href = res.data["message"];
            }
            else {
                alert(res.data["message"]);
            }
        }
    </script>
{% endblock %}